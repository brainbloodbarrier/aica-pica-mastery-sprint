name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff
    
    - name: Run Ruff linter
      run: |
        ruff check . --output-format=github
        echo "✅ Ruff linting passed!"
    
    - name: Run Ruff formatter check
      run: |
        ruff format --check .
        echo "✅ Ruff formatting check passed!"

  validate-content:
    name: Validate Notebook Content
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Validate JSON data files
      run: |
        python3 -m json.tool data/AICA_content.json > /dev/null
        echo "✅ AICA_content.json is valid"
        python3 -m json.tool data/PICA_content.json > /dev/null
        echo "✅ PICA_content.json is valid"
    
    - name: Install dependencies for citation validation
      run: |
        python -m pip install --upgrade pip
        # Only install what's needed for the validation script
    
    - name: Run citation validation
      run: |
        python3 scripts/validate_citations.py
      continue-on-error: true
      # Note: We continue even if some citations are missing since
      # earlier modules may have different citation formats
    
    - name: Check notebook integrity
      run: |
        python3 -m json.tool AICA_PICA_Mastery_Sprint.ipynb > /dev/null
        echo "✅ Notebook JSON is valid"

  test-notebook:
    name: Test Notebook Execution
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test notebook can be converted
      run: |
        jupyter nbconvert --to html --execute AICA_PICA_Mastery_Sprint.ipynb --ExecutePreprocessor.timeout=300
        echo "✅ Notebook executed successfully!"
      continue-on-error: true
      # Note: Full execution may timeout or require user interaction,
      # but this verifies the notebook structure is valid

  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify critical imports
      run: |
        python -c "import jupyter; print(f'✅ jupyter {jupyter.__version__}')"
        python -c "import notebook; print(f'✅ notebook {notebook.__version__}')"
        python -c "import ipywidgets; print(f'✅ ipywidgets {ipywidgets.__version__}')"
        python -c "import IPython; print(f'✅ IPython {IPython.__version__}')"
        python -c "import ipykernel; print(f'✅ ipykernel {ipykernel.__version__}')"
        echo "✅ All critical dependencies are importable!"
